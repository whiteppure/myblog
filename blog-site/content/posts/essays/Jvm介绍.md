---
title: "Jvm介绍"
date: 2021-03-05
draft: false
tags: ["Java","Jvm"]
slug: "jvm-start"
---

## 为什么要学习Jvm
大部分Java开发人员，除了会在项目中使用到与Java平台相关的各种高精尖技术，对于Java技术的核心Java虚拟机了解甚少。
一些有一定工作经验的开发人员，打心眼儿里觉得SSM、微服务等上层技术才是重点，基础技术并不重要，
这其实是一种本末倒置的“病态”。
如果我们把核心类库的API比做数学公式的话，那么Java虚拟机的知识就好比公式的推导过程。

> 不要以钱为你的最终目标，当你把技术做到位的时候，你会发现你的薪资待遇、社会地位，都会自然而然的提升上来。不要本末倒置、急功近利。

- 面试的需要(BATJ、TMD，PKQ等面试都爱问)
- 中高级程序员必备技能：项目管理、调优的需求
- 追求极客的精神，比如：垃圾回收算法、JIT（即时编译器）、底层原理

垃圾收集机制为我们打理了很多繁琐的工作，大大提高了开发的效率，
但是，垃圾收集也不是万能的，懂得JVM内部的内存结构、工作机制，是设计高扩展性应用和诊断运行时问题的基础，也是Java工程师进阶的必备能力。

## 虚拟机概念

所谓虚拟机（Virtual Machine），就是一台虚拟的计算机。它是一款软件，用来执行一系列虚拟计算机指令。
大体上，虚拟机可以分为系统虚拟机和程序虚拟机。

- 大名鼎鼎的Virtual Box，VMware就属于系统虚拟机，它们完全是对物理计算机的仿真，提供了一个可运行完整操作系统的软件平台。
- 程序虚拟机的典型代表就是Java虚拟机，它专门为执行单个计算机程序而设计，在Java虚拟机中执行的指令我们称为Java字节码指令。
- 无论是系统虚拟机还是程序虚拟机，在上面运行的软件都被限制于虚拟机提供的资源中.

### Java虚拟机
- Java虚拟机是一台执行Java字节码的虚拟计算机，它拥有独立的运行机制，其运行的Java字节码也未必由Java语言编译而成。
- JVM平台的各种语言可以共享Java虚拟机带来的跨平台性、优秀的垃圾回器，以及可靠的即时编译器。
- Java技术的核心就是Java虚拟机（JVM，Java Virtual Machine），因为所有的Java程序都运行在Java虚拟机内部。
- Java虚拟机就是二进制字节码的运行环境，负责装载字节码到其内部，解释/编译为对应平台上的机器指令执行。每一条Java指令，Java虚拟机规范中都有详细定义，如怎么取操作数，怎么处理操作数，处理结果放在哪里。

## Jvm整体结构
HotSpot VM是目前市面上高性能虚拟机的代表作之一。下图就是 HotSport 虚拟机结构图
![Jvm内存模型](/myblog/posts/images/essays/Jvm内存模型.png)

- 类加载子系统：将字节码文件加载到内存当中生成一个class文件。具体分为三部分：装载，链接，初始化。
- 运行时数据区：方法区、堆、Java栈（虚拟机栈）、本地方法栈、程序计数器。其中线程共享，堆和方法区；Java栈、本地方法栈和程序计数器为每个线程独有一份的。
- 执行引擎：包括：解释器、JIT及时编译器、GC垃圾回收器。

## Java代码执行流程
Java代码通过编译器生成字节码文件，字节码通过Java虚拟机跟操作系统交互。
![Java代码执行流程](/myblog/posts/images/essays/Java代码执行流程.png)

## Jvm架构模型
Java编译器输入的指令流基本上是一种 **基于栈的指令集架构** ，另外一种指令集架构则是 **基于寄存器的指令集架构** 。
Hotsport 是基于栈的指令集架构。

**基于栈式架构的特点**
- 设计和实现更简单，适用于资源受限的系统
- 避开了寄存器的分配难题：使用零地址指令方式分配
- 指令流中的指令大部分是零地址指令，其执行过程依赖于操作栈。指令集更小，编译器容易实现
- 不需要硬件支持，可移植性更好，更好实现跨平台

**基于寄存器架构的特点**
- 典型的应用是x86的二进制指令集：比如传统的PC以及Android的Davlik虚拟机。
- 指令集架构则完全依赖硬件，与硬件的耦合度高，可移植性差
- 性能优秀和执行更高效
- 花费更少的指令去完成一项操作
- 在大部分情况下，基于寄存器架构的指令集往往都以一地址指令、二地址指令和三地址指令为主，而基于栈式架构的指令集却是以零地址指令为主

## Jvm生命周期

启动 --> 执行 --> 退出

**虚拟机的启动**
- Java虚拟机的启动是通过引导类加载器（bootstrap class loader）创建一个初始类（initial class）来完成的，这个类是由虚拟机的具体实现指定的。

**虚拟机的执行**
- 一个运行中的Java虚拟机有着一个清晰的任务：执行Java程序
- 程序开始执行时他才运行，程序结束时他就停止
- 执行一个所谓的Java程序的时候，真真正正在执行的是一个叫做Java虚拟机的进程

**虚拟机的退出**
- 程序正常执行结束
- 程序在执行过程中遇到了异常或错误而异常终止
- 由于操作系统用现错误而导致Java虚拟机进程终止
- 某线程调用Runtime类或System类的exit()方法，或Runtime类的halt()方法，并且Java安全管理器也允许这次exit()或halt()操作。
- 除此之外，JNI（Java Native Interface）规范描述了用JNI Invocation API来加载或卸载 Java虚拟机时，Java虚拟机的退出情况。
